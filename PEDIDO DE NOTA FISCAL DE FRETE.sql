SELECT D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA, D1_PEDIDO,NOMEFOR,F8_NFDIFRE,F8_SEDIFRE,F8_FORNECE ,F8_LOJTRAN,
NOMETRP ,F8_NFORIG,D1_EMISSAO, F1_VALBRUT 
 
FROM (SELECT D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA, D1_PEDIDO,SA2.A2_NOME NOMEFOR,F8_NFDIFRE,F8_SEDIFRE,F8_FORNECE ,F8_LOJTRAN,
SA21.A2_NOME NOMETRP,F8_NFORIG,D1_EMISSAO, F1_VALBRUT 

FROM SD1010 SD1

INNER JOIN SA2010 SA2 ON SA2.A2_COD = D1_FORNECE
AND SA2.A2_LOJA = D1_LOJA  
AND SA2.D_E_L_E_T_ <>'*'
 
INNER JOIN SF1010 SF1 ON F1_FILIAL = D1_FILIAL 
AND D1_DOC = F1_DOC 
AND D1_SERIE = F1_SERIE 
AND D1_FORNECE = F1_FORNECE 
AND D1_LOJA = F1_LOJA

LEFT JOIN SF8010 SF8 ON F8_FILIAL = F1_FILIAL 
AND F8_SERORIG = F1_SERIE 
AND F8_NFORIG = F1_DOC 
AND F8_FORNECE = F1_FORNECE
AND F1_LOJA = F8_LOJA 
AND SF8.D_E_L_E_T_ <>'*'

LEFT JOIN SA2010 SA21 ON SA21.A2_COD = F8_FORNECE  
AND SA21.A2_LOJA = F8_LOJTRAN  
AND SA21.D_E_L_E_T_ <>'*'
 
WHERE D1_PEDIDO <>'' 
AND D1_EMISSAO >='20160101' 
AND SD1.D_E_L_E_T_ <>'*') XX
 
GROUP BY D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA, D1_PEDIDO,NOMEFOR,F8_NFDIFRE,F8_SEDIFRE,F8_FORNECE ,F8_LOJTRAN,
NOMETRP,F8_NFORIG,D1_EMISSAO, F1_VALBRUT